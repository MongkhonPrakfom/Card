<?php
session_start();
include('connectiondb.php');

if (isset($_POST['register'])) {
    $P_nama = mysqli_real_escape_string($conn, $_POST['nama']);
    $P_jawatan = mysqli_real_escape_string($conn, $_POST['jawatan']);
    $P_department = mysqli_real_escape_string($conn, $_POST['department']);
    $P_alamat = mysqli_real_escape_string($conn, $_POST['alamat']);
    $P_negeri = mysqli_real_escape_string($conn, $_POST['negeri']);
    $P_syarikat = mysqli_real_escape_string($conn, $_POST['syarikat']);
    $P_tel = $_POST['tel'];
    $P_email = mysqli_real_escape_string($conn, $_POST['email']);
    $P_tarikh = $_POST['tarikh'];
    $P_pic = $_FILES['pic']['name']; 

    $_SESSION['nama'] = $P_nama;
    $_SESSION['jawatan'] = $P_jawatan;
    $_SESSION['department'] = $P_department;
    $_SESSION['alamat'] = $P_alamat;
    $_SESSION['negeri'] = $P_negeri;
    $_SESSION['syarikat'] = $P_syarikat;
    $_SESSION['tel'] = $P_tel;
    $_SESSION['email'] = $P_email;
    $_SESSION['tarikh'] = $P_tarikh;
    $_SESSION['pic'] = $P_pic;

    // Semak sama ada semua medan telah diisi
    if (empty($P_nama) || empty($P_jawatan) || empty($P_department) || empty($P_alamat)
        || empty($P_negeri) || empty($P_syarikat) || empty($P_tel) || empty($P_tarikh) || empty($P_email)) {
        header('Location: form.php?incomplete=yes');
        exit;
    }

    // Semak sama ada data sudah wujud dalam pangkalan data
    $checkQuery = "SELECT * FROM client WHERE nama = '$P_nama' AND jawatan = '$P_jawatan' AND no_telefon = '$P_tel' AND email = '$P_email'";
    $checkResult = $conn->query($checkQuery);

    if ($checkResult->num_rows > 0) {
        // Jika data wujud, paparkan mesej dan halakan semula ke borang
        echo "<script>
                alert('Data already exists. Please enter different data.');
                window.location.href = 'form.php';
              </script>";
        exit;
    }

    // Tambahkan gambar jika ada
    $mypic = null;
    if (!empty($_FILES['pic']['tmp_name'])) {
        $image = $_FILES['pic']['tmp_name'];
        $mypic = addslashes(file_get_contents($image));
    }

    // Tambahkan data baharu ke pangkalan data
    $cmdadd = "INSERT INTO client (nama, jawatan, department, alamat, negeri, nama_syarikat, no_telefon, email, tarikh_daftar, gambar)
            VALUES ('$P_nama', '$P_jawatan', '$P_department', '$P_alamat', '$P_negeri', '$P_syarikat', '$P_tel', '$P_email', '$P_tarikh', '$mypic')";

    $resultadd = $conn->query($cmdadd);

    if ($resultadd) {
        echo "<script>
                alert('Data has been record.');
                window.location.href = 'display.php';
              </script>";
        exit;
    } else {
        echo "<script>
                alert('ERROR: Data cannot to record. {$conn->error}');
                window.location.href = 'form.php';
              </script>";
    }
}
?>
