<?php
session_start();
$conn = mysqli_connect("localhost", "root", "", "po1");

require 'vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
use PhpOffice\PhpSpreadsheet\Style\Alignment;

// Export to Excel
if (isset($_POST['export_excel'])) {
    $query = "SELECT * FROM client"; // Replace with your actual table name
    $result = mysqli_query($conn, $query);
    
    $spreadsheet = new Spreadsheet();
    $sheet = $spreadsheet->getActiveSheet();

    // Set column headings
    $headers = ['A' => 'ID', 'B' => 'Name', 'C' => 'Position', 'D' => 'Department', 'E' => 'Address', 'F' => 'State',
                'G' => 'Company Name', 'H' => 'No Phone', 'I' => 'Email', 'J' => 'Registration Date'];
    
    foreach ($headers as $col => $title) {
        $sheet->setCellValue($col . '1', $title);
        $sheet->getStyle($col . '1')->getFont()->setBold(true);
        $sheet->getStyle($col . '1')->getAlignment()->setHorizontal(Alignment::HORIZONTAL_CENTER);
    }

    // Set column widths
    $columnWidths = ['A' => 5, 'B' => 30, 'C' => 20, 'D' => 20, 'E' => 45, 'F' => 15, 'G' => 45, 'H' => 15, 'I' => 25, 'J' => 20];
    foreach ($columnWidths as $col => $width) {
        $sheet->getColumnDimension($col)->setWidth($width);
    }

    // Populate data
    $rowNum = 2; // Start from the second row
    while ($row = mysqli_fetch_assoc($result)) {
        $sheet->setCellValue('A' . $rowNum, $row['id']);
        $sheet->setCellValue('B' . $rowNum, $row['nama']);
        $sheet->setCellValue('C' . $rowNum, $row['jawatan']);
        $sheet->setCellValue('D' . $rowNum, $row['department']);
        $sheet->setCellValue('E' . $rowNum, $row['alamat']);
        $sheet->setCellValue('F' . $rowNum, $row['negeri']);
        $sheet->setCellValue('G' . $rowNum, $row['nama_syarikat']);
        $sheet->setCellValue('H' . $rowNum, $row['no_telefon']);
        $sheet->setCellValue('I' . $rowNum, '=HYPERLINK("mailto:' . $row['email'] . '", "' . $row['email'] . '")');
        $sheet->setCellValue('J' . $rowNum, $row['tarikh_daftar']);
        
        // Auto-size row height
        $sheet->getRowDimension($rowNum)->setRowHeight(-1);
        
        $rowNum++;
    }
    
    // Wrap text for address column
    $sheet->getStyle('E')->getAlignment()->setWrapText(true);
    
    $writer = new Xlsx($spreadsheet);
    $filename = 'export_data.xlsx';
    
    // Set headers to download the file
    header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    header('Content-Disposition: attachment;filename="' . $filename . '"');
    header('Cache-Control: max-age=0');

    $writer->save('php://output');
    exit();
}
?>
